name: Smart Build Debug APK (Manual)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # è¯Šæ–­æ­¥éª¤
      - name: Print configuration files
        run: |
          echo "### gradle-wrapper.properties ###"
          cat gradle/wrapper/gradle-wrapper.properties || echo "Not found"
          echo "### root build.gradle.kts ###"
          cat build.gradle.kts || echo "Not found"
          echo "### gradle/libs.versions.toml (if exists) ###"
          cat gradle/libs.versions.toml || echo "Not found"
          echo "### settings.gradle.kts ###"
          cat settings.gradle.kts || echo "Not found"

      - name: Check Gradle and AGP compatibility
        run: |
          GRADLE_VERSION=$(grep distributionUrl gradle/wrapper/gradle-wrapper.properties | grep -oE 'gradle-[0-9.]+' | cut -d- -f2)
          AGP_VERSION=$(grep -E "com.android.application.*version" build.gradle.kts | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || echo "unknown")
          echo "Detected Gradle version: $GRADLE_VERSION"
          echo "Detected AGP version: $AGP_VERSION"
          if [[ -n "$AGP_VERSION" && "$AGP_VERSION" != "unknown" ]]; then
            AGP_MAJOR=$(echo $AGP_VERSION | cut -d. -f1)
            AGP_MINOR=$(echo $AGP_VERSION | cut -d. -f2)
            if [[ $AGP_MAJOR -eq 8 ]]; then
              case $AGP_MINOR in
                0|1|2|3) REQUIRED_GRADLE="6.8" ;;
                4) REQUIRED_GRADLE="7.5" ;;
                5) REQUIRED_GRADLE="8.7" ;;
                6) REQUIRED_GRADLE="8.9" ;;
                7) REQUIRED_GRADLE="8.11.1" ;;
                8|9|10|11|12|13) REQUIRED_GRADLE="8.13" ;;
                *) REQUIRED_GRADLE="unknown" ;;
              esac
              echo "AGP $AGP_VERSION requires Gradle >= $REQUIRED_GRADLE"
            fi
          else
            echo "AGP version not detected, skipping compatibility check."
          fi

      - name: Ensure Material3 theme exists
        run: |
          THEME_FILE="app/src/main/res/values/themes.xml"
          if [ ! -f "$THEME_FILE" ]; then
            echo "Theme file not found, creating default one..."
            mkdir -p app/src/main/res/values
            cat > "$THEME_FILE" <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <style name="Theme.DeepSleepController" parent="Theme.Material3.Light.NoActionBar" />
          </resources>
          EOF
            echo "Created $THEME_FILE"
          else
            echo "Theme file exists, checking parent..."
            if ! grep -q "Theme.Material3.Light.NoActionBar" "$THEME_FILE"; then
              echo "WARNING: Theme.DeepSleepController does not seem to inherit from Material3. Please check."
            else
              echo "Theme looks good."
            fi
          fi

      - name: Check duplicate theme definitions
        run: |
          echo "Searching for Theme.DeepSleepController in all resource files..."
          DUPLICATES=$(find app/src/main/res -name "*.xml" -exec grep -l "Theme.DeepSleepController" {} \;)
          if [ -n "$DUPLICATES" ]; then
            COUNT=$(echo "$DUPLICATES" | wc -l)
            if [ $COUNT -gt 1 ]; then
              echo "âŒ Duplicate theme definitions found in:"
              echo "$DUPLICATES"
              echo "Please keep only one definition (preferably in themes.xml) and remove others."
            else
              echo "âœ… Theme defined only in: $DUPLICATES"
            fi
          else
            echo "âš ï¸ Theme not found anywhere. Will be created in step 3 if needed."
          fi

      - name: Run Lint
        run: ./gradlew lint || echo "Lint found issues, but continuing..."

      - name: Run unit tests
        run: ./gradlew testDebugUnitTest || echo "Unit tests failed, but continuing..."

      # æž„å»ºå¹¶ä¿å­˜å®Œæ•´æ—¥å¿—ï¼ˆå³ä½¿å¤±è´¥ä¹Ÿä¿å­˜ï¼‰
      - name: Build Debug APK (with log capture)
        run: ./gradlew assembleDebug --stacktrace 2>&1 | tee build.log
        continue-on-error: true   # ç¡®ä¿å³ä½¿æž„å»ºå¤±è´¥ï¼ŒåŽç»­æ­¥éª¤ä»ä¼šæ‰§è¡Œ

      # åˆ†æžé”™è¯¯å¹¶ç”ŸæˆæŠ¥å‘Šï¼ˆæ— è®ºæž„å»ºæ˜¯å¦æˆåŠŸéƒ½è¿è¡Œï¼‰
      - name: Analyze errors and generate report
        if: always()
        run: |
          echo "# Build Error Summary" > error-report.md
          echo "" >> error-report.md
          echo "## ðŸ” Diagnostic Results" >> error-report.md
          echo "" >> error-report.md
          
          if [ -f build.log ]; then
            if grep -q "FAILURE:" build.log; then
              echo "## âŒ Build Failed" >> error-report.md
              echo "" >> error-report.md
              echo "### First 30 errors/warnings from build log:" >> error-report.md
              echo '```' >> error-report.md
              grep -E "^e:|^error:|FAILURE:|Unresolved reference|Suspend function|type mismatch" build.log | head -30 >> error-report.md
              echo '```' >> error-report.md
              echo "" >> error-report.md
              echo "### Possible categories:" >> error-report.md
              
              if grep -q "Unresolved reference.*BuildConfig" build.log; then
                echo "- ðŸ”§ **BuildConfig missing**: Add import or enable buildConfig feature." >> error-report.md
              fi
              if grep -q "Suspend function.*should be called only from a coroutine" build.log; then
                echo "- ðŸ”§ **Suspend function called outside coroutine**: Wrap calls with lifecycleScope/ viewModelScope/ rememberCoroutineScope." >> error-report.md
              fi
              if grep -q "resource.*not found" build.log; then
                echo "- ðŸ”§ **Resource not found**: Check theme inheritance or missing dependencies (e.g., Material)." >> error-report.md
              fi
            else
              echo "## âœ… Build Succeeded" >> error-report.md
            fi
          else
            echo "## âš ï¸ Build log not found" >> error-report.md
          fi
          
          echo "" >> error-report.md
          echo "---" >> error-report.md
          echo "Full build log is attached as \`build.log\`. Lint and test reports are also available if generated." >> error-report.md

      - name: Upload build reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: |
            build.log
            error-report.md
            app/build/reports/lint-results-*.html
            app/build/reports/tests/
          if-no-files-found: ignore

      - name: Upload APK (if generated)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: deep-sleep-controller-debug
          path: app/build/outputs/apk/debug/*.apk